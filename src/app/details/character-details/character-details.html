<article>
    <section class="details-heading horizontal-section">
        <h2 class="character-title">{{ worldCharacter?.firstName }} {{ worldCharacter?.lastName }}</h2>
        @if (worldCharacter && worldCharacter.altNames && worldCharacter.altNames.length > 0) {
            <h3 class="subtitle">( {{ worldCharacter.altNames.join(', ') }} )</h3>
        }
        <button class="delete-button secondary" (click)="deleteCharacter()">Delete Character</button>
    </section>
    <form [formGroup]="applyForm" (submit)="updateCharacter()">
        <section class="edit-character-form character-page-body">
            <div class="details-section primary-section horizontal-section">
                <div class="details-section secondary-section">
                    <label class="primary-label" for="character-first-name">Name</label>
                    <input id="character-first-name" type="text" formControlName="characterFirstName" placeholder="First name" />
                    <input id="character-last-name" type="text" formControlName="characterLastName" placeholder="Last name" required="true"/>
                    
                    <label class="primary-label" for="character-alt-names">Alternate Names</label>
                    <input id="character-alt-names" type="text" formControlName="characterAltNames" placeholder="Nicknames, aliases, etc..." />
                </div>
                <div class="details-section secondary-section">
                    <label class="primary-label" for="character-pronouns">Pronouns</label>
                    <input id="character-pronouns" type="text" formControlName="characterPronouns" placeholder="he/him, she/her, they/them, etc..." />
                    
                    <label class="primary-label">Birthdate</label>
                    <div class="date-selector">
                        <input id="character-birth-year" type="number" formControlName="characterBirthYear" placeholder="Year" min="1800" max="3000" />
                        <select id="character-birth-month" formControlName="characterBirthMonth">
                            <option value="">Month</option>
                            @for (month of months; track month) {
                                <option value="{{ month }}">{{ month }}</option>
                            }
                        </select>
                        <input id="character-birth-day" type="number" formControlName="characterBirthDay" placeholder="Day" min="1" max="31" />
                    </div>
                </div>
            </div>
            <div class="details-section primary-section horizontal-section">
                <div class="details-section secondary-section">
                    <label class="primary-label" for="character-physical-description">Physical Description</label>
                    <textarea id="character-physical-description" class="medium-textarea" formControlName="characterPhysicalDescription" placeholder="Describe their appearance, height, build, distinguishing features..."></textarea>
                </div>
                <div class="details-section secondary-section">
                    <label class="primary-label" for="character-non-physical-description">Non-Physical Description</label>
                    <textarea id="character-non-physical-description" class="medium-textarea" formControlName="characterNonPhysicalDescription" placeholder="Describe their personality, mannerisms, speech patterns..."></textarea>
                </div>
            </div>
            <div class="details-section primary-section horizontal-section">
                <div class="details-section secondary-section">
                    <label class="primary-label" for="roles">Roles</label>
                    <input id="roles" type="text" formControlName="characterRoles" placeholder="Job, title, function in story..." />
                </div>
                <div class="details-section secondary-section">
                    <label class="primary-label" for="character-affiliations">Affiliations</label>
                    <input id="character-affiliations" type="text" formControlName="characterAffiliations" placeholder="Groups, organizations, factions..." />
                </div>
            </div>
            <div class="details-section primary-section vertical-section">
                <label class="primary-label" for="character-relationships">Relationships</label>
                <!-- <input id="character-relationships" type="text" formControlName="characterRelationships" /> -->
                <div class="details-section secondary-section grid-section">
                    @for(character of characterList; track character) {
                        <!-- If not the current character -->
                        @if(worldCharacter?.id !== character.id) {
                            <div class="relationship-section" id="relationship-{{character.id}}">
                                <div class="relationship-header">
                                    <input type="checkbox" id="relationship-checkbox-{{character.id}}" [value]="character.id" (change)="toggleRelationship($event, character.id)" [checked]="getRelationship(character.id)?.hasRelationship"/>
                                    <button class="linked-character" [routerLink]="['/character', character.id]">
                                        <label for="relationship-textarea-{{character.id}}" class="secondary-label">{{ character.firstName }} {{ character.lastName }}</label>
                                    </button>
                                </div>
                                @if(character.altNames && character.altNames.length > 0) {           
                                    <p class="alt-names">( {{ character.altNames.join(', ') }} )</p>
                                }
                                @if (getRelationship(character.id)?.hasRelationship) {
                                    <input type="text" class="relationship-type-input" id="relationship-type-{{character.id}}" placeholder="Relationship Type" [value]="getRelationship(character.id)?.relationshipType?.join(', ')"/>
                                    <textarea class="medium-textarea relationship-textarea" id="relationship-description-{{character.id}}" placeholder="Describe relationship...">{{ getRelationship(character.id)?.relationshipDescription }}</textarea>
                                } @else {
                                    <input type="text" class="relationship-type-input hidden" id="relationship-type-{{character.id}}" placeholder="Relationship Type" [value]="getRelationship(character.id)?.relationshipType?.join(', ')"/>
                                    <textarea class="medium-textarea relationship-textarea hidden" id="relationship-description-{{character.id}}" placeholder="Describe relationship...">{{ getRelationship(character.id)?.relationshipDescription }}</textarea>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
            <div class="details-section primary-section horizontal-section">                
                <div class="details-section secondary-section">
                    <label class="primary-label" for="character-stories">Stories</label>
                    <!-- <input id="character-stories" type="text" formControlName="characterStories" /> -->
                    <div class="wrap-section">
                        @for(story of storyList; track story) {
                            <div class="form-field">
                                <input type="checkbox" id="story-checkbox-{{story.id}}" [value]="story.id" (change)="onStoryChange($event, story.id)" [checked]="isStoryInCharacter(story.title)" />
                                <button class="linked-story" [routerLink]="['/story', story.id]" type="button">
                                    <label class="secondary-label">{{ story.title }}</label>
                                </button>
                            </div>
                        }
                    </div>
                </div>
                <div class="details-section secondary-section">
                    <label class="primary-label" for="character-tags">Tags</label>
                    <textarea class="small-textarea" id="character-tags" formControlName="characterTags" placeholder="Enter tags separated by commas..."></textarea>
                </div>
            </div>
            
            <!-- Character Locations Section -->
            <div class="details-section primary-section horizontal-section">
                <div class="details-section secondary-section full-width">
                    <label class="primary-label">Associated Locations</label>
                    <div class="wrap-section">
                        @for(location of locationList; track location) {
                            <div class="form-field">
                                <input type="checkbox" id="location-checkbox-{{location.id}}" [value]="location.id" (change)="onLocationChange($event, location.id)" [checked]="isLocationAssociatedWithCharacter(location.name)" />
                                <button class="linked-location" [routerLink]="['/location', location.id]" type="button">
                                    <label class="secondary-label">{{ location.name }}</label>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Character Timeline Section -->
        <section class="details-section primary-section vertical-section">
            <app-timeline 
                [events]="filteredEventList" 
                [title]="'Events for ' + (worldCharacter?.firstName || '') + ' ' + (worldCharacter?.lastName || '')"
                [noResultsMessage]="'No events found for this character'"
                (tagClicked)="onTimelineTagClicked($event)">
            </app-timeline>
        </section>
        
        <button type="submit" class="save-button primary">Save</button>
    </form>
</article>